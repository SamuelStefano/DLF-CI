name: CI

on:
  pull_request:
  workflow_call:

permissions:
  contents: read
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint (gerar relat√≥rio)
        id: lint
        run: npx eslint --config eslint.config.js . -f json -o eslint-report.json || true

      - name: Checagem de arquitetura
        id: architecture
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { checkArchitecture } = require('./.github/workflows/architecture-check.js');
          
          const files = fs.readdirSync('.', { recursive: true })
            .filter(f => /\.(ts|tsx)$/.test(f) && !f.includes('node_modules'));
          
          const issues = [];
          files.forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            const fileIssues = checkArchitecture(file, content);
            fileIssues.forEach(issue => {
              issues.push({ file, ...issue });
            });
          });
          
          fs.writeFileSync('architecture-report.json', JSON.stringify(issues));
          " || true

      - name: Typecheck
        id: typecheck
        run: npm run typecheck
        continue-on-error: true

      - name: Comentar erros inline
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            if (!fs.existsSync('eslint-report.json')) {
              console.log('Nenhum relat√≥rio de lint encontrado');
              return;
            }

            const report = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));
            const files = report.filter(f => f.messages.length > 0);
            
            if (files.length === 0) {
              console.log('Nenhum erro de lint encontrado');
              return;
            }

            const translateMessage = (ruleId, message) => {
              const translations = {
                // TypeScript
                '@typescript-eslint/no-unused-vars': `**Vari√°vel n√£o utilizada**: ${message.split("'")[1] || 'esta vari√°vel'} foi declarada mas nunca √© usada. Remova-a ou adicione um underscore no in√≠cio se for intencional.`,
                '@typescript-eslint/no-unused-expressions': '**Express√£o sem efeito**: Esta linha n√£o faz nada √∫til. Voc√™ esqueceu de atribuir a uma vari√°vel ou chamar uma fun√ß√£o?',
                '@typescript-eslint/no-explicit-any': '**Tipo `any` detectado**: Evite usar `any`. Defina o tipo correto ou use `unknown` se necess√°rio.',
                '@typescript-eslint/no-var-requires': '**Use import ES6**: Substitua `require()` por `import` para consist√™ncia.',
                
                // Coment√°rios
                'no-inline-comments': '**Coment√°rio inline**: Evite coment√°rios na mesma linha do c√≥digo. Coloque o coment√°rio na linha de cima para melhor legibilidade.',
                'line-comment-position': '**Posi√ß√£o do coment√°rio**: Coment√°rios devem ficar acima do c√≥digo, n√£o ao lado.',
                'no-warning-comments': '**Coment√°rio de alerta**: Remova TODOs, FIXMEs e coment√°rios tempor√°rios antes de commitar.',
                'spaced-comment': '**Formata√ß√£o de coment√°rio**: Adicione um espa√ßo ap√≥s `//` ou `/*`.',
                
                // Qualidade de c√≥digo e componentiza√ß√£o
                'max-lines': `**Arquivo muito longo**: Este arquivo tem mais de 150 linhas. Considere dividir em componentes ou m√≥dulos menores.`,
                'max-lines-per-function': '**Componente/fun√ß√£o muito longo**: Esta fun√ß√£o tem mais de 100 linhas. Divida em fun√ß√µes/componentes menores ou extraia l√≥gica para hooks customizados.',
                'max-statements': '**Muitas declara√ß√µes**: Esta fun√ß√£o tem muitas vari√°veis/statements. Considere extrair l√≥gica para hooks customizados ou dividir o componente.',
                'max-params': '**Muitos par√¢metros**: Esta fun√ß√£o recebe muitos par√¢metros. Use um objeto de configura√ß√£o ou divida a fun√ß√£o.',
                'complexity': '**Complexidade alta**: Esta fun√ß√£o √© muito complexa. Divida em fun√ß√µes menores e mais simples.',
                'max-depth': '**Aninhamento excessivo**: Muitos n√≠veis de `if`/`for` aninhados. Simplifique a l√≥gica ou extraia fun√ß√µes.',
                'max-nested-callbacks': '**Callbacks aninhados**: Muitos callbacks dentro de callbacks. Use async/await ou extraia fun√ß√µes.',
                'no-console': '**Console detectado**: Remova `console.log` antes de commitar. Use um logger adequado.',
                
                // Next.js
                '@next/next/no-html-link-for-pages': '**Use next/link**: Substitua `<a href>` por `<Link>` do Next.js para navega√ß√£o entre p√°ginas.',
                '@next/next/no-img-element': '**Use next/image**: Substitua `<img>` por `<Image>` do Next.js para otimiza√ß√£o autom√°tica.',
                '@next/next/no-sync-scripts': '**Script s√≠ncrono**: Use `<Script>` do Next.js com strategy adequada (beforeInteractive, afterInteractive, lazyOnload).',
                '@next/next/no-page-custom-font': '**Fonte customizada**: Use `next/font` para otimiza√ß√£o autom√°tica de fontes.',
                
                // Organiza√ß√£o
                '@typescript-eslint/consistent-type-definitions': '**Use interface**: Prefira `interface` em vez de `type` para defini√ß√µes de objetos (melhor para extends e merge).',
                
                // React
                'react/jsx-key': '**Faltou `key` prop**: Elementos em arrays/itera√ß√µes precisam de uma prop `key` √∫nica. Exemplo: `<div key={item.id}>`',
                'react/jsx-no-duplicate-props': '**Props duplicadas**: Voc√™ declarou a mesma prop mais de uma vez neste componente.',
                'react/jsx-no-undef': `**Componente n√£o definido**: ${message.split("'")[1] || 'Este componente'} n√£o foi importado ou n√£o existe.`,
                'react/no-children-prop': '**Uso incorreto de children**: Use `<Componente>conte√∫do</Componente>` em vez de `<Componente children="conte√∫do" />`.',
                'react/no-danger-with-children': '**Conflito perigoso**: N√£o use `dangerouslySetInnerHTML` junto com children.',
                'react/no-deprecated': '**API descontinuada**: Este recurso do React est√° deprecated. Verifique a documenta√ß√£o para alternativas.',
                'react/no-direct-mutation-state': '**Muta√ß√£o direta de state**: Nunca altere `this.state` diretamente. Use `setState()`.',
                'react/no-unescaped-entities': '**Entidade n√£o escapada**: Use `&quot;`, `&apos;`, `&gt;`, `&lt;` ou coloque o texto dentro de `{}`.',
                'react/self-closing-comp': '**Tag n√£o auto-fechada**: Componentes sem children devem usar `<Componente />` em vez de `<Componente></Componente>`.',
                
                // React Hooks
                'react-hooks/rules-of-hooks': '**Regra de Hooks violada**: Hooks s√≥ podem ser chamados no n√≠vel superior de componentes funcionais. N√£o use dentro de condi√ß√µes, loops ou fun√ß√µes aninhadas.',
                'react-hooks/exhaustive-deps': '**Depend√™ncias faltando**: O array de depend√™ncias do Hook est√° incompleto. Adicione todas as vari√°veis usadas dentro do Hook ou remova o Hook se n√£o for necess√°rio.',
              };
              
              return translations[ruleId] || `**${ruleId}**: ${message}`;
            };

            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request?.number;
            
            if (!pr_number) {
              console.log('N√£o √© um pull request, pulando coment√°rios');
              return;
            }

            // Buscar arquivos modificados no PR
            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: pr_number,
            });

            const modifiedFiles = new Set(prFiles.map(f => f.filename));

            for (const file of files) {
              const relativePath = path.relative(process.cwd(), file.filePath);
              
              // S√≥ comenta em arquivos que foram modificados
              if (!modifiedFiles.has(relativePath)) continue;

              for (const msg of file.messages) {
                const translatedMessage = translateMessage(msg.ruleId, msg.message);
                const severity = msg.severity === 2 ? 'üö´ ERRO' : '‚ö†Ô∏è ATEN√á√ÉO';
                
                const body = `${severity}\n\n${translatedMessage}\n\n---\n<sub>Regra: \`${msg.ruleId}\`</sub>`;

                try {
                  await github.rest.pulls.createReviewComment({
                    owner,
                    repo,
                    pull_number: pr_number,
                    body,
                    commit_id: context.payload.pull_request.head.sha,
                    path: relativePath,
                    line: msg.line,
                  });
                } catch (error) {
                  console.log(`Erro ao comentar em ${relativePath}:${msg.line}: ${error.message}`);
                }
              }
            }

            // Processar issues de arquitetura
            if (fs.existsSync('architecture-report.json')) {
              const archIssues = JSON.parse(fs.readFileSync('architecture-report.json', 'utf8'));
              
              for (const issue of archIssues) {
                if (!modifiedFiles.has(issue.file)) continue;
                
                const severity = issue.severity === 'error' ? 'üö´ ERRO' : 'üí° SUGEST√ÉO';
                const body = `${severity}\n\n${issue.message}\n\n---\n<sub>An√°lise de Arquitetura</sub>`;
                
                try {
                  await github.rest.pulls.createReviewComment({
                    owner,
                    repo,
                    pull_number: pr_number,
                    body,
                    commit_id: context.payload.pull_request.head.sha,
                    path: issue.file,
                    line: issue.line,
                  });
                } catch (error) {
                  console.log(`Erro ao comentar arquitetura em ${issue.file}:${issue.line}: ${error.message}`);
                }
              }
            }

      - name: Verificar se CI falhou
        if: always()
        run: |
          if [ -f eslint-report.json ]; then
            ERRORS=$(node -e "const r = require('./eslint-report.json'); console.log(r.reduce((acc, f) => acc + f.errorCount, 0))")
            if [ "$ERRORS" -gt 0 ]; then
              echo "‚ùå Encontrados $ERRORS erros de lint"
              exit 1
            fi
          fi
          if [ "${{ steps.typecheck.outcome }}" == "failure" ]; then
            echo "‚ùå Typecheck falhou"
            exit 1
          fi

  comment:
    needs: ci
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR when CI fails
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const marker = "‚ùå CI falhou (lint/typecheck).";

            const body = [
              marker,
              `Logs completos: ${runUrl}`,
              "Pr√≥ximo passo: abrir os logs, corrigir o erro apontado e rodar `npm run lint` e `npm run typecheck` localmente antes do pr√≥ximo push."
            ].join("\n\n");

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            // Procura coment√°rio existente do bot com o marcador
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });

            const existing = comments.find(
              (c) =>
                c.user?.login === "github-actions[bot]" &&
                c.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
